<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Character Sheet Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=EB+Garamond:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            .page-break { page-break-after: always; }
            .usage-box, .spell-slot-box { border: 1px solid #5c4d3d !important; }
            .usage-box:checked, .spell-slot-box:checked { background-color: #3a2d21 !important; }
        }
        body { font-family: 'EB Garamond', serif; background-color: #fdf6e3; color: #3a2d21; }
        .font-fell { font-family: 'IM Fell English SC', serif; }
        .sheet-wrapper { max-width: 8.5in; margin: 1rem auto; position: relative; }
        .sheet-container {
            min-height: 11in; height: 11in;
            border: 2px solid #5c4d3d; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            background-image: url('https://www.transparenttextures.com/patterns/old-paper.png');
            background-color: #fdf6e3; display: none; flex-direction: column;
        }
        .sheet-visible { display: flex; }
        .header-main h1 { color: #8c1d1d; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .section-header {
            font-family: 'IM Fell English SC', serif; font-weight: 400; font-size: 1.5rem; color: #8c1d1d;
            border-bottom: 2px solid #c9b7a2; padding-bottom: 0.25rem; margin-bottom: 0.75rem; letter-spacing: 0.05em;
        }
        .stat-box { border: 1px solid #c9b7a2; background-color: rgba(255, 255, 255, 0.2); border-radius: 2px; padding: 0.5rem; text-align: center; }
        .ability-score { font-family: 'EB Garamond', serif; font-size: 1.75rem; font-weight: 700; }
        .ability-modifier {
            font-size: 1rem; font-weight: 700; border: 1px solid #3a2d21; border-radius: 50%;
            width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
            margin: 0.25rem auto 0; background-color: #eaddc7;
        }
        .skill-list li { padding: 0; line-height: 1.2; border-bottom: 1px dotted #dcd1c0; }
        .skill-list li:last-child { border-bottom: none; }
        .proficient::before { content: 'â™¦'; margin-right: 0.5em; color: #8c1d1d; }
        .feature-box, .spell-box { margin-bottom: 0.75rem; }
        .feature-title, .spell-title { font-weight: bold; font-family: 'EB Garamond', serif; }
        .feature-desc, .spell-desc { font-size: 0.9rem; color: #5c4d3d; font-style: italic; margin-top: 0.25rem; }
        .attack-box { padding: 0.5rem; border: 1px solid #c9b7a2; border-radius: 0; background-color: transparent; }
        .bordered-section { border: 1px solid #c9b7a2; padding: 0.75rem; background-color: rgba(255,255,255,0.1); }
        .save-dot { width: 1rem; height: 1rem; border-radius: 50%; border: 1px solid #3a2d21; background-color: rgba(0,0,0,0.05); }
        .control-panel button, .icon-button, .editor-button {
            background-color: #8c1d1d; color: #fdf6e3; border: 1px solid #5c4d3d;
            padding: 0.5rem; border-radius: 2px; cursor: pointer; transition: background-color 0.2s;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .control-panel button:hover, .icon-button:hover, .editor-button:hover { background-color: #6a1616; }
        .control-panel select, .control-panel input[type=text] { background-color: #eaddc7; border: 1px solid #5c4d3d; padding: 0.5rem; border-radius: 2px; }
        .usage-tracker { display: inline-flex; align-items: center; gap: 0.25rem; margin-left: 0.75rem; }
        .usage-box, .spell-slot-box {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 0.9rem; height: 0.9rem; border: 1px solid #5c4d3d; background-color: #fdf6e3;
            cursor: pointer; position: relative; border-radius: 2px;
        }
        .usage-box:checked, .spell-slot-box:checked { background-color: #3a2d21; }
        .usage-box:checked::after, .spell-slot-box:checked::after {
            content: '\\2713'; color: #fdf6e3; position: absolute; left: 50%; top: 50%;
            transform: translate(-50%, -50%); font-size: 0.7rem; line-height: 1;
        }
        .spell-slot-group { display: flex; align-items: center; margin-bottom: 0.5rem; }
        .spell-slot-label { width: 80px; font-weight: bold; }
        .sheet-controls { position: absolute; top: 1.5rem; right: 1.5rem; z-index: 10; display: none; }
        .editor-button { padding: 0.5rem 1rem; }
        .flowing-columns { column-count: 2; column-gap: 1.5rem; height: 100%; }
        .flowing-columns > section { break-inside: avoid; }

        /* Edit Mode Styles */
        .edit-mode-input { width: 100%; background-color: #fdf6e3; border: 1px dashed #c9b7a2; padding: 2px 4px; }
        .edit-mode-textarea { width: 100%; background-color: #fdf6e3; border: 1px dashed #c9b7a2; padding: 2px 4px; min-height: 50px; font-style: italic; font-size: 0.9rem;}
        .edit-stat { width: 40px; text-align: center; background-color: #fdf6e3; border: 1px solid #c9b7a2; }
        .edit-mode-small-btn { font-size: 0.7rem; padding: 0 4px; margin-left: 8px; border-radius: 50%; background-color: #8c1d1d; color: #fdf6e3; border: none; cursor: pointer; }
    </style>
</head>
<body class="p-4">
    <div class="control-panel max-w-5xl mx-auto p-4 mb-4 no-print bg-amber-50 rounded shadow-md border border-amber-200">
        <h1 class="font-fell text-3xl text-red-800 text-center mb-4">Character Sheet Creator</h1>
        <div class="grid grid-cols-2 gap-x-4 gap-y-2 items-center">
            <div class="flex justify-start items-center gap-4">
                <button id="new-char-btn" title="New Character"><i data-feather="file-plus"></i></button>
                <label for="character-select" class="font-fell">Load Character:</label>
                <select id="character-select" class="flex-grow"></select>
                <label for="char-file-input" class="icon-button" title="Load character from file">
                    <i data-feather="folder"></i>
                </label>
                <input type="file" id="char-file-input" accept=".json" class="hidden">
            </div>
             <div class="flex justify-end items-center gap-4">
                <label for="session-name" class="font-fell">Session Name:</label>
                <input type="text" id="session-name" placeholder="E.g., Curse of Strahd" class="flex-grow">
            </div>
            <div class="col-span-2 flex justify-end mt-2">
                <button id="clear-library-btn" class="bg-gray-600 hover:bg-gray-700 text-xs py-1 px-2">Clear Entire Library</button>
            </div>
        </div>
    </div>
    
    <div id="welcome-message" class="text-center p-10 max-w-4xl mx-auto bg-amber-50 rounded shadow-md border border-amber-200">
        <h2 class="font-fell text-2xl">Welcome, Gamemaster!</h2>
        <p class="mt-2">Start by creating a <button id="welcome-new-char-btn" class="text-red-800 font-bold underline">new character</button> or loading a character file.</p>
    </div>

    <div class="sheet-wrapper">
        <div id="sheet-controls" class="no-print space-x-2">
            <button id="edit-char-btn" class="icon-button" title="Toggle Edit Mode" disabled><i data-feather="edit-2"></i></button>
            <button id="export-json-btn" class="icon-button" title="Save & Export JSON" disabled><i data-feather="save"></i></button>
            <button id="print-btn" class="icon-button" title="Print Sheet"><i data-feather="printer"></i></button>
        </div>
        <!-- Page Containers -->
        <div id="sheet-container-front" class="sheet-container p-6 page-break"></div>
        <div id="sheet-container-back" class="sheet-container p-6"></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let isEditing = false;
    let currentCharacterData = null;
    const STORAGE_KEY = 'dndCharacterLibrary';

    const fileInput = document.getElementById('char-file-input');
    const characterSelect = document.getElementById('character-select');
    const sessionNameInput = document.getElementById('session-name');
    const printBtn = document.getElementById('print-btn');
    const clearLibraryBtn = document.getElementById('clear-library-btn');
    const welcomeMessage = document.getElementById('welcome-message');
    const sheetFront = document.getElementById('sheet-container-front');
    const sheetBack = document.getElementById('sheet-container-back');
    const newCharBtn = document.getElementById('new-char-btn');
    const welcomeNewCharBtn = document.getElementById('welcome-new-char-btn');
    const editCharBtn = document.getElementById('edit-char-btn');
    const exportJsonBtn = document.getElementById('export-json-btn');
    const sheetControls = document.getElementById('sheet-controls');

    const getMod = (score) => Math.floor((score - 10) / 2);
    const formatMod = (mod) => mod >= 0 ? `+${mod}` : mod.toString();

    const getLibrary = () => JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
    const saveLibrary = (library) => localStorage.setItem(STORAGE_KEY, JSON.stringify(library));

    const showSheets = () => {
        welcomeMessage.style.display = 'none';
        sheetFront.classList.add('sheet-visible');
        sheetBack.classList.add('sheet-visible');
        sheetControls.style.display = 'flex';
        editCharBtn.disabled = false;
        exportJsonBtn.disabled = false;
    };

    const populateCharacterSelect = () => {
        const library = getLibrary();
        characterSelect.innerHTML = '<option value="">Select a character...</option>';
        Object.entries(library).forEach(([session, chars]) => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = session;
            chars.forEach(char => {
                const option = new Option(char.name, `${session}|${char.name}`);
                optgroup.appendChild(option);
            });
            characterSelect.appendChild(optgroup);
        });
    };

    const handleFileLoad = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (!data.name || !data.abilityScores || !data.proficiencies) {
                    throw new Error("Invalid character sheet format.");
                }
                currentCharacterData = data;
                isEditing = false;
                renderCharacterSheet();
                saveCurrentCharacterToLibrary();
                populateCharacterSelect();
                characterSelect.value = `${sessionNameInput.value.trim() || 'Uncategorized'}|${data.name}`;
            } catch (error) {
                alert(`Error loading file: ${error.message}`);
            }
        };
        reader.readAsText(file);
        fileInput.value = '';
    };
    
    const saveCurrentCharacterToLibrary = () => {
        if (!currentCharacterData) return;
        const sessionName = sessionNameInput.value.trim() || 'Uncategorized';
        const library = getLibrary();
        if (!library[sessionName]) library[sessionName] = [];
        const existingIndex = library[sessionName].findIndex(c => c.name === currentCharacterData.name);
        if (existingIndex > -1) {
            library[sessionName][existingIndex] = currentCharacterData;
        } else {
            library[sessionName].push(currentCharacterData);
        }
        saveLibrary(library);
    };

    const loadFromSelect = () => {
        const [sessionName, charName] = characterSelect.value.split('|');
        if (!sessionName || !charName) return;
        const library = getLibrary();
        const data = library[sessionName]?.find(c => c.name === charName);
        if (data) {
            currentCharacterData = data;
            isEditing = false;
            renderCharacterSheet();
            sessionNameInput.value = sessionName;
        }
    };

    const clearLibrary = () => {
        if (confirm("Are you sure you want to delete all saved characters?")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    };
    
    const handleNewCharacter = () => {
        currentCharacterData = createBlankCharacter();
        isEditing = true;
        renderCharacterSheet();
    };

    const handleEditToggle = () => {
        if (isEditing) gatherDataFromForm();
        isEditing = !isEditing;
        renderCharacterSheet();
    };

    const handleExport = () => {
        if (isEditing) gatherDataFromForm();
        if (!currentCharacterData) return;
        const jsonString = JSON.stringify(currentCharacterData, null, 2);
        const blob = new Blob([jsonString], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentCharacterData.name.toLowerCase().replace(/\s+/g, '_')}.json`;
        a.click();
        URL.revokeObjectURL(url);
        saveCurrentCharacterToLibrary();
        populateCharacterSelect();
        characterSelect.value = `${sessionNameInput.value.trim() || 'Uncategorized'}|${currentCharacterData.name}`;
    };

    fileInput.addEventListener('change', handleFileLoad);
    characterSelect.addEventListener('change', loadFromSelect);
    printBtn.addEventListener('click', () => window.print());
    clearLibraryBtn.addEventListener('click', clearLibrary);
    newCharBtn.addEventListener('click', handleNewCharacter);
    welcomeNewCharBtn.addEventListener('click', handleNewCharacter);
    editCharBtn.addEventListener('click', handleEditToggle);
    exportJsonBtn.addEventListener('click', handleExport);
    
    populateCharacterSelect();
    feather.replace();

    function gatherDataFromForm() {
        const data = createBlankCharacter();
        data.name = document.getElementById('edit-char-name').value;
        data.title = document.getElementById('edit-char-title').value;
        data.class = document.getElementById('edit-char-class').value;
        data.level = parseInt(document.getElementById('edit-char-level').value) || 1;
        data.race = document.getElementById('edit-char-race').value;
        data.background = document.getElementById('edit-char-background').value;
        Object.keys(data.abilityScores).forEach(key => {
            data.abilityScores[key] = parseInt(document.getElementById(`edit-ability-${key}`).value) || 10;
        });
        data.profBonus = parseInt(document.getElementById('edit-prof-bonus').value) || 2;
        data.combat.ac = parseInt(document.getElementById('edit-combat-ac').value) || 10;
        data.combat.hp_max = parseInt(document.getElementById('edit-combat-hp_max').value) || 1;
        data.combat.speed = document.getElementById('edit-combat-speed').value;
        data.personality.traits = document.getElementById('edit-personality-traits').value;
        data.personality.ideal = document.getElementById('edit-personality-ideal').value;
        data.personality.bond = document.getElementById('edit-personality-bond').value;
        data.personality.flaw = document.getElementById('edit-personality-flaw').value;
        data.equipment = document.getElementById('edit-equipment-list').value;
        data.features = [];
        document.querySelectorAll('.edit-feature-item').forEach(item => {
            data.features.push({
                title: item.querySelector('.edit-feature-title').value,
                desc: item.querySelector('.edit-feature-desc').value,
                key: item.querySelector('.edit-feature-key').checked
            });
        });
        data.spells = [];
        document.querySelectorAll('.edit-spell-item').forEach(item => {
            data.spells.push({
                name: item.querySelector('.edit-spell-name').value,
                level: item.querySelector('.edit-spell-level').value,
                desc: item.querySelector('.edit-spell-desc').value
            });
        });
        const spellAbilitySelect = document.getElementById('edit-spell-ability');
        if (spellAbilitySelect) {
            data.spellcasting = { ability: spellAbilitySelect.value, spellSlots: {} };
            for (let i = 1; i <= 9; i++) {
                const slotInput = document.getElementById(`edit-spell-slot-l${i}`);
                if (slotInput) {
                    const value = parseInt(slotInput.value) || 0;
                    if (value > 0) data.spellcasting.spellSlots[`level${i}`] = value;
                }
            }
        } else {
            data.spellcasting = null;
        }
        if(currentCharacterData) {
            data.proficiencies = currentCharacterData.proficiencies;
            data.attacks = currentCharacterData.attacks;
            data.features.forEach((f, i) => {
                const originalFeature = currentCharacterData.features.find(origF => origF.title === f.title);
                if(originalFeature && originalFeature.uses) f.uses = originalFeature.uses;
            });
        }
        currentCharacterData = data;
    }

    const createBlankCharacter = () => ({
        "name": "New Character", "title": "", "class": "", "level": 1, "race": "", "background": "",
        "abilityScores": {"str": 10, "dex": 10, "con": 10, "int": 10, "wis": 10, "cha": 10},
        "profBonus": 2, "proficiencies": {"savingThrows": [], "skills": []},
        "combat": {"ac": 10, "hp_max": 1, "speed": "30ft"},
        "attacks": [], "features": [], "equipment": "",
        "personality": {"traits": "", "ideal": "", "bond": "", "flaw": ""},
        "spellcasting": null, "spells": []
    });
    
    function renderCharacterSheet() {
        if (!currentCharacterData) return;
        showSheets();
        
        editCharBtn.innerHTML = isEditing ? `<i data-feather="eye"></i>` : `<i data-feather="edit-2"></i>`;
        editCharBtn.title = isEditing ? "View Mode" : "Edit Mode";
        
        const data = currentCharacterData;
        const abilityMods = Object.fromEntries(Object.entries(data.abilityScores).map(([key, value]) => [key, getMod(value)]));

        const keyFeatures = data.features.filter(f => f.key);
        const otherFeatures = data.features.filter(f => !f.key);

        sheetFront.innerHTML = `
            <header class="grid grid-cols-3 gap-4 border-b-2 border-black pb-2 mb-3">
                <div class="col-span-2 header-main">
                    ${isEditing ? `<input id="edit-char-name" class="edit-mode-input text-4xl font-fell text-red-800" value="${data.name}">` : `<h1 class="text-4xl font-fell">${data.name}</h1>`}
                    ${isEditing ? `<input id="edit-char-title" class="edit-mode-input text-lg italic text-gray-700" value="${data.title}">` : `<p class="text-lg text-gray-700 italic">${data.title}</p>`}
                </div>
                <div class="text-right text-sm">
                    ${isEditing ? `
                        <p><strong>Class:</strong> <input id="edit-char-class" class="edit-mode-input" value="${data.class}"></p>
                        <p><strong>Level:</strong> <input id="edit-char-level" type="number" class="edit-stat" value="${data.level}"></p>
                        <p><strong>Race:</strong> <input id="edit-char-race" class="edit-mode-input" value="${data.race}"></p>
                        <p><strong>Background:</strong> <input id="edit-char-background" class="edit-mode-input" value="${data.background}"></p>
                    ` : `
                        <p><strong>Class:</strong> ${data.class} ${data.level}</p><p><strong>Race:</strong> ${data.race}</p><p><strong>Background:</strong> ${data.background}</p>
                    `}
                </div>
            </header>
            <main class="grid grid-cols-3 gap-6 flex-grow">
                <!-- COL 1: Exploration -->
                <div class="col-span-1 space-y-3 flex flex-col">
                    <section class="grid grid-cols-2 gap-3">
                        ${Object.entries(data.abilityScores).map(([key, value]) => `
                            <div class="stat-box">
                                <label class="font-fell text-sm">${key.toUpperCase()}</label>
                                ${isEditing ? `<input type="number" id="edit-ability-${key}" class="ability-score edit-stat" value="${value}">` : `<div class="ability-score">${value}</div>`}
                                <div class="ability-modifier">${formatMod(abilityMods[key])}</div>
                            </div>
                        `).join('')}
                    </section>
                    <div class="text-center">
                        ${isEditing ? `<input type="number" id="edit-prof-bonus" class="font-bold text-lg edit-stat" value="${data.profBonus}">` : `<span class="font-bold text-lg mr-2">${formatMod(data.profBonus)}</span>`}
                        <label class="font-fell text-lg">Proficiency Bonus</label>
                    </div>
                    <section class="bordered-section flex-grow"><h3 class="font-fell font-bold border-b border-gray-400 mb-1">Skills</h3><ul class="text-sm skill-list">
                        ${Object.entries({ "Acrobatics": "dex", "Animal Handling": "wis", "Arcana": "int", "Athletics": "str", "Deception": "cha", "History": "int", "Insight": "wis", "Intimidation": "cha", "Investigation": "int", "Medicine": "wis", "Nature": "int", "Perception": "wis", "Performance": "cha", "Persuasion": "cha", "Religion": "int", "Sleight of Hand": "dex", "Stealth": "dex", "Survival": "wis" }).map(([name, stat]) => {
                             const isProf = data.proficiencies.skills.includes(name.toLowerCase().replace(/ /g, ''));
                             return `<li class="${isProf ? 'proficient' : ''}">${name} <span class="text-gray-500">(${stat.toUpperCase()})</span><strong class="float-right">${formatMod(abilityMods[stat] + (isProf ? data.profBonus : 0))}</strong></li>`;
                        }).join('')}
                    </ul></section>
                </div>
                <!-- COL 2: Combat -->
                <div class="col-span-1 space-y-3 flex flex-col">
                     <section class="grid grid-cols-3 gap-3 text-center">
                        ${isEditing ? `
                            <div class="stat-box"><input type="number" id="edit-combat-ac" class="ability-score edit-stat" value="${data.combat.ac}"><div class="font-fell text-xs">ARMOR CLASS</div></div>
                            <div class="stat-box"><div class="ability-score">${formatMod(abilityMods.dex)}</div><div class="font-fell text-xs">INIT</div></div>
                            <div class="stat-box"><input id="edit-combat-speed" class="ability-score edit-stat w-full" value="${data.combat.speed}"><div class="font-fell text-xs">SPEED</div></div>
                        ` : `
                            <div class="stat-box"><div class="ability-score">${data.combat.ac}</div><div class="font-fell text-xs">ARMOR CLASS</div></div>
                            <div class="stat-box"><div class="ability-score">${formatMod(abilityMods.dex)}</div><div class="font-fell text-xs">INIT</div></div>
                            <div class="stat-box"><div class="ability-score">${data.combat.speed.replace('ft','<span class="text-base">ft</span>')}</div><div class="font-fell text-xs">SPEED</div></div>
                        `}
                    </section>
                    <section class="bordered-section text-center">
                        <label class="font-fell text-lg">Hit Points</label>
                        ${isEditing ? `<input type="number" id="edit-combat-hp_max" class="text-3xl font-bold tracking-wider edit-stat" value="${data.combat.hp_max}">` : `<div class="text-3xl font-bold tracking-wider">${data.combat.hp_max} / ${data.combat.hp_max}</div>`}
                        <div class="mt-2"><label class="font-fell">Hit Dice</label><div class="text-lg font-bold">${data.level}d${data.class.toLowerCase().includes('fighter') ? 10 : data.class.toLowerCase().includes('wizard') ? 6 : 8}</div></div>
                    </section>
                    <section class="bordered-section text-center"><h3 class="font-fell text-lg mb-2">Death Saves</h3><div class="flex justify-around items-center"><div><span class="text-sm">Successes</span><div class="flex space-x-2 mt-1">${[...Array(3)].map(() => `<div class="save-dot"></div>`).join('')}</div></div><div><span class="text-sm">Failures</span><div class="flex space-x-2 mt-1">${[...Array(3)].map(() => `<div class="save-dot"></div>`).join('')}</div></div></div></section>
                    <section class="bordered-section flex-grow"><h3 class="font-fell font-bold border-b border-gray-400 mb-1">Saving Throws</h3><ul class="text-sm space-y-1 skill-list">
                        ${Object.entries({str: "Strength", dex: "Dexterity", con: "Constitution", int: "Intelligence", wis: "Wisdom", cha: "Charisma"}).map(([key, name]) => {
                            const isProf = data.proficiencies.savingThrows.includes(key);
                            return `<li class="${isProf ? 'proficient' : ''}"><span>${name}</span><strong class="float-right">${formatMod(abilityMods[key] + (isProf ? data.profBonus : 0))}</strong></li>`;
                        }).join('')}
                    </ul></section>
                    <section><h2 class="section-header">Attacks</h2><div class="space-y-3">
                        ${data.attacks.map(attack => `<div class="attack-box"><p><strong>${attack.name}:</strong> <span class="float-right"><strong>Atk:</strong> ${formatMod(abilityMods[attack.atkStat] + data.profBonus)} | <strong>Dmg:</strong> ${attack.dmgDie}${formatMod(abilityMods[attack.dmgStat] + (attack.dmgBonus || 0))} ${attack.type}</span></p><p class="text-xs text-gray-600 italic mt-1">${attack.notes || ''}</p></div>`).join('')}
                    </div></section>
                </div>
                <!-- COL 3: Actions -->
                 <div class="col-span-1 space-y-4">
                    <section class="bordered-section text-sm mb-4">
                        <h2 class="section-header">Personality</h2>
                        ${isEditing ? `
                            <p class="mb-2"><strong>Traits:</strong> <textarea id="edit-personality-traits" class="edit-mode-textarea">${data.personality.traits}</textarea></p>
                            <p class="mb-2"><strong>Ideal:</strong> <textarea id="edit-personality-ideal" class="edit-mode-textarea">${data.personality.ideal}</textarea></p>
                            <p class="mb-2"><strong>Bond:</strong> <textarea id="edit-personality-bond" class="edit-mode-textarea">${data.personality.bond}</textarea></p>
                            <p><strong>Flaw:</strong> <textarea id="edit-personality-flaw" class="edit-mode-textarea">${data.personality.flaw}</textarea></p>
                        ` : `
                            <p class="mb-2"><strong>Traits:</strong> <span class="italic">${data.personality.traits}</span></p>
                            <p class="mb-2"><strong>Ideal:</strong> <span class="italic">${data.personality.ideal}</span></p>
                            <p class="mb-2"><strong>Bond:</strong> <span class="italic">${data.personality.bond}</span></p>
                            <p><strong>Flaw:</strong> <span class="italic">${data.personality.flaw}</span></p>
                        `}
                    </section>
                    <section id="key-features-section" class="text-sm"></section>
                </div>
            </main>
        `;
        renderKeyFeatures(keyFeatures);
        
        let backPageHTML = `<main class="flex-grow flowing-columns">`;

        if (data.spellcasting) {
            backPageHTML += `<section id="spellcasting-section-render" class="mt-4 flex-grow flex flex-col"></section>`;
        }

        backPageHTML += `
            <section class="mb-4"><h2 class="section-header">Features & Traits</h2><div id="features-list-render" class="space-y-3 text-sm"></div></section>
            <section><h2 class="section-header">Equipment</h2>${isEditing ? `<textarea id="edit-equipment-list" class="edit-mode-textarea">${data.equipment}</textarea>`: `<p class="text-sm italic">${data.equipment}</p>`}</section>
        `;

        backPageHTML += `</main>`;
        sheetBack.innerHTML = backPageHTML;
        
        renderFeatureList(otherFeatures);
        if (data.spellcasting) renderSpellcastingSection(data, abilityMods);
        feather.replace();
    }
    
    function renderKeyFeatures(features) {
        const container = document.getElementById('key-features-section');
        if (!container) return;
        if (features.length > 0) {
            container.innerHTML = `<h2 class="section-header">Key Features</h2>` + features.map(f => {
                    const usageHTML = f.uses ? `<div class="usage-tracker">${[...Array(f.uses.total)].map(() => `<input type="checkbox" class="usage-box">`).join('')}<span class="text-xs italic text-gray-500"> per ${f.uses.per}</span></div>` : '';
                    return `<div class="feature-box text-sm"><div class="flex items-center flex-wrap"><p class="feature-title">${f.title}</p>${usageHTML}</div><p class="feature-desc">${f.desc.replace(/<li>/g, '<li class="list-disc list-inside">')}</p></div>`;
                }).join('');
        } else {
            container.innerHTML = '';
        }
    }

    function renderFeatureList(features) {
        const container = document.getElementById('features-list-render');
        if (!container) return;
        if (isEditing) {
            container.innerHTML = currentCharacterData.features.map((f, i) => `
                <div class="edit-feature-item bordered-section mb-2">
                    <div class="flex justify-between items-center">
                        <input class="edit-mode-input font-bold edit-feature-title" value="${f.title}">
                        <button class="edit-mode-small-btn" onclick="removeListItem('features', ${i})">X</button>
                    </div>
                    <textarea class="edit-mode-textarea edit-feature-desc">${f.desc}</textarea>
                    <div class="mt-1 text-xs">
                        <input type="checkbox" id="key-feature-${i}" class="edit-feature-key" ${f.key ? 'checked' : ''}>
                        <label for="key-feature-${i}">Show on front page as Key Feature</label>
                    </div>
                </div>
            `).join('') + `<button class="mt-2 text-sm editor-button" onclick="addListItem('features')">+ Add Feature</button>`;
        } else {
            container.innerHTML = features.length > 0 ? features.map(f => {
                const usageHTML = f.uses ? `<div class="usage-tracker">${[...Array(f.uses.total)].map(() => `<input type="checkbox" class="usage-box">`).join('')}<span class="text-xs italic text-gray-500"> per ${f.uses.per}</span></div>` : '';
                return `<div class="feature-box"><div class="flex items-center flex-wrap"><p class="feature-title">${f.title}</p>${usageHTML}</div><p class="feature-desc">${f.desc.replace(/<li>/g, '<li class="list-disc list-inside">')}</p></div>`;
            }).join('') : `<p class="italic text-center text-gray-500 pt-8">No other features.</p>`;
        }
        feather.replace();
    }
    
    function renderSpellcastingSection(data, abilityMods) {
        const container = document.getElementById('spellcasting-section-render');
        if (!container) return;
        const stLabels = {str: "Strength", dex: "Dexterity", con: "Constitution", int: "Intelligence", wis: "Wisdom", cha: "Charisma"};
        
        if (isEditing) {
             container.innerHTML = `
                <h2 class="section-header">Spellcasting <button onclick="toggleSpellcaster(false)" class="edit-mode-small-btn" title="Remove Spellcaster Status">X</button></h2>
                <div class="mb-2">
                    <label class="font-fell">Ability:</label>
                    <select id="edit-spell-ability" class="edit-mode-input w-auto">
                        ${Object.keys(stLabels).map(key => `<option value="${key}" ${data.spellcasting.ability === key ? 'selected' : ''}>${stLabels[key]}</option>`).join('')}
                    </select>
                </div>
                <h3 class="font-fell text-lg mb-2">Spell Slots</h3>
                <div class="grid grid-cols-3 gap-x-4 gap-y-2 mb-4">
                    ${[...Array(9)].map((_, i) => `
                        <div>
                            <label class="text-sm">Level ${i + 1}:</label>
                            <input type="number" id="edit-spell-slot-l${i + 1}" class="edit-stat w-12" value="${(data.spellcasting.spellSlots && data.spellcasting.spellSlots[`level${i + 1}`]) || 0}">
                        </div>
                    `).join('')}
                </div>
                <div id="spells-list-render" class="space-y-3 text-sm flex-grow"></div>
            `;
             renderSpellList(data.spells);
        } else { 
            if (data.spellcasting) {
                const spellMod = abilityMods[data.spellcasting.ability];
                const spellSaveDC = 8 + data.profBonus + spellMod;
                const spellAttack = data.profBonus + spellMod;
                container.innerHTML = `
                    <h2 class="section-header">Spellcasting</h2>
                    <div class="grid grid-cols-3 gap-2 text-center mb-4">
                        <div class="stat-box text-sm"><div class="font-bold text-base">${stLabels[data.spellcasting.ability]}</div><div class="font-fell text-xs">ABILITY</div></div>
                        <div class="stat-box text-sm"><div class="font-bold text-base">${spellSaveDC}</div><div class="font-fell text-xs">SAVE DC</div></div>
                        <div class="stat-box text-sm"><div class="font-bold text-base">${formatMod(spellAttack)}</div><div class="font-fell text-xs">ATTACK BONUS</div></div>
                    </div>
                    <div class="mb-4">
                        ${(data.spellcasting.spellSlots && Object.entries(data.spellcasting.spellSlots).map(([level, total]) => total > 0 ? `
                            <div class="spell-slot-group"><span class="spell-slot-label">Level ${level.replace('level','')}</span><div class="flex flex-wrap gap-2">
                                ${[...Array(total)].map(() => `<input type="checkbox" class="spell-slot-box">`).join('')}
                            </div></div>` : '').join('')) || ''
                        }
                    </div>
                    <div id="spells-list-render" class="space-y-3 text-sm flex-grow"></div>
                `;
                renderSpellList(data.spells);
            }
        }
        feather.replace();
    }
    
    function renderSpellList(spells) {
        const container = document.getElementById('spells-list-render');
        if (!container && !isEditing) return;
        
        let spellContent = '';
        if(isEditing && currentCharacterData.spellcasting === null){
            const spellcastingSection = document.getElementById('spellcasting-section-render');
            if (spellcastingSection) {
                spellcastingSection.innerHTML = `<div class="text-center p-8 bordered-section"><p class="italic text-gray-600 mb-4">This character is not a spellcaster.</p><button onclick="toggleSpellcaster(true)" class="editor-button">Make Spellcaster</button></div>`;
            }
            return;
        }

        spellContent = spells.map((s, i) => {
            if (isEditing) {
                return `<div class="edit-spell-item bordered-section mb-2">
                    <input class="edit-mode-input font-bold edit-spell-name" value="${s.name}" placeholder="Spell Name">
                    <input type="number" class="edit-mode-input text-xs w-16 mt-1 edit-spell-level" value="${s.level}" placeholder="Lvl">
                    <textarea class="edit-mode-textarea mt-1 edit-spell-desc">${s.desc}</textarea>
                    <button class="edit-mode-small-btn" onclick="removeListItem('spells', ${i})">X</button>
                </div>`;
            } else {
                return `<div class="spell-box"><p class="spell-title">${s.name} <span class="text-xs font-normal italic"> (Lvl ${s.level})</span></p><p class="spell-desc">${s.desc}</p></div>`;
            }
        }).join('');
        
        const addSpellButton = isEditing ? `<button class="mt-2 text-sm editor-button" onclick="addListItem('spells')">+ Add Spell</button>` : '';
        const noSpellsMessage = !isEditing && spells.length === 0 ? `<p class="italic text-center text-gray-500 pt-8">No spells known.</p>` : '';

        container.innerHTML = spellContent + addSpellButton + noSpellsMessage;
        feather.replace();
    }
    
    window.toggleSpellcaster = (makeCaster) => {
        gatherDataFromForm();
        if (makeCaster) {
            currentCharacterData.spellcasting = { ability: 'int', spellSlots: { level1: 2 } };
        } else {
            currentCharacterData.spellcasting = null;
        }
        renderCharacterSheet();
    };

    window.addListItem = (type) => {
        gatherDataFromForm();
        if (type === 'features') {
            currentCharacterData.features.push({title: "New Feature", desc: "", key: false});
        } else if (type === 'spells') {
            currentCharacterData.spells.push({name: "New Spell", level: 1, desc: ""});
        }
        renderCharacterSheet();
    };
    
    window.removeListItem = (type, index) => {
        gatherDataFromForm();
        if (type === 'features') {
            currentCharacterData.features.splice(index, 1);
        } else if (type === 'spells') {
            currentCharacterData.spells.splice(index, 1);
        }
        renderCharacterSheet();
    };
});
</script>
</body>
</html>

